<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ESAN - Trayectoria histórica</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
</head>

<body>
  <a-scene>
    <a-assets>
      <img id="esan360" src="patio.jpg">
      <video id="videoUni" src="video2.mp4" preload="auto"
             crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <a-sky src="#esan360" rotation="0 -90 0"></a-sky>

    <a-sphere
      id="telonNegro"
      radius="60"
      material="color: #000; side: back; transparent: true; opacity: 0; shader: flat"
      animation__oscurecer="property: material.opacity; to: 1; dur: 2000; startEvents: cineStart"
      animation__aclarar="property: material.opacity; to: 0; dur: 2000; startEvents: cineEnd">
    </a-sphere>

    <a-entity id="grupoVideo" position="0 1.6 -4" visible="false">
      <a-video id="pantallaVideo" src="#videoUni" width="5" height="3"></a-video>
      <a-plane id="barraFondo" width="5" height="0.12" color="#696a6d" position="0 -1.6 0.01"></a-plane>
      <a-plane id="barraProgreso" width="0.01" height="0.12" color="#E3173E" position="-2.5 -1.6 0.02"></a-plane>
      <a-text id="textoDuracion" value="0:00 / 0:00" color="#FFFFFF" width="3" align="right" position="2.4 -1.48 0.10"></a-text>

      <a-entity id="controles" position="0 -1.9 0.1">
        <a-circle id="btnReset" class="clickable" color="#FFFFFF" radius="0.2" position="-1.2 0 0">
          <a-text value="Reiniciar" align="center" color="#000000" width="2"></a-text>
        </a-circle>
        <a-circle id="btnNormal" class="clickable" color="#FFFFFF" radius="0.2" position="-0.6 0 0">
          <a-text value="1x" align="center" color="#E3173E" width="2"></a-text>
        </a-circle>
        <a-circle id="btnPausa" class="clickable" color="#E3173E" radius="0.25" position="0 0 0">
          <a-text id="txtPausa" value="PAUSA" align="center" color="#FFFFFF" width="2"></a-text>
        </a-circle>
        <a-circle id="btnRapido" class="clickable" color="#FFFFFF" radius="0.2" position="0.6 0 0">
          <a-text value="2x >>" align="center" color="#E3173E" width="2"></a-text>
        </a-circle>
        <a-circle id="btnSalir" class="clickable" color="#E3173E" radius="0.2" position="1.3 0 0">
          <a-text value="Volver al\ninicio" align="center" color="#FFFFFF" width="2"></a-text>
        </a-circle>
      </a-entity>
    </a-entity>

    <a-entity id="contenedorBoton" position="0 1.6 -3" scale="1 1 1" visible="true">
      <a-circle id="btnAccion" class="clickable" color="#000000" opacity="0.8" radius="0.65"
                animation__pulse="property: scale; to: 1.1 1.1 1.1; dur: 1000; dir: alternate; loop: true">
        <a-text id="textoBoton" value="CONOCE NUESTRA\nHISTORIA" align="center" color="#FFFFFF" width="3"></a-text>
      </a-circle>
    </a-entity>

    <a-entity id="rig" position="0 0 0">
      <a-camera look-controls wasd-controls>
        <a-cursor color="#FFD700" raycaster="objects: .clickable"></a-cursor>
      </a-camera>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable" line="color: #FFD700; opacity: 0.9"></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable" line="color: #FFD700; opacity: 0.9"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    const video = document.querySelector('#videoUni');
    const grupoVideo = document.querySelector('#grupoVideo');
    const contenedorBtn = document.querySelector('#contenedorBoton');
    const textoBoton = document.querySelector('#textoBoton');
    const telon = document.querySelector('#telonNegro');
    const txtPausa = document.querySelector('#txtPausa');
    const barraProgreso = document.querySelector('#barraProgreso');
    const textoDuracion = document.querySelector('#textoDuracion');

    let DURACION_TOTAL = 0;
    const ANCHO_BARRA = 5;

    function formatearTiempo(segundos) {
      if (isNaN(segundos)) return "0:00";
      const min = Math.floor(segundos / 60);
      const seg = Math.floor(segundos % 60);
      return `${min}:${seg.toString().padStart(2, '0')}`;
    }

    video.addEventListener('loadedmetadata', () => {
      DURACION_TOTAL = video.duration;
      textoDuracion.setAttribute('value', `0:00 / ${formatearTiempo(DURACION_TOTAL)}`);
    });

    // --- FUNCIÓN DE ACTUALIZACIÓN CORREGIDA ---
    function actualizarInterfaz() {
      // Si el video no tiene duración o está pausado, no hacemos nada
      if (!DURACION_TOTAL) return;

      const tiempoActual = video.currentTime;
      const progreso = tiempoActual / DURACION_TOTAL;

      // Actualizar ancho de la barra
      barraProgreso.setAttribute('width', Math.max(0.01, progreso * ANCHO_BARRA));
      
      // Actualizar posición de la barra (para que crezca hacia la derecha)
      barraProgreso.setAttribute('position', `${-2.5 + (progreso * ANCHO_BARRA) / 2} -1.6 0.02`);

      // Actualizar texto de tiempo
      textoDuracion.setAttribute('value', `${formatearTiempo(tiempoActual)} / ${formatearTiempo(DURACION_TOTAL)}`);

      // Si el video sigue reproduciéndose, pedimos el siguiente frame para suavidad total
      if (!video.paused) {
        requestAnimationFrame(actualizarInterfaz);
      }
    }

    // AGREGADO: Escuchar el evento nativo para asegurar que se llene siempre
    video.addEventListener('timeupdate', actualizarInterfaz);

    document.querySelector('#btnAccion').addEventListener('click', () => {
      contenedorBtn.setAttribute('visible', 'false');
      telon.emit('cineStart'); 
      grupoVideo.setAttribute('visible', 'true');
      
      video.play().then(() => {
          actualizarInterfaz();
      }).catch(err => console.log("Esperando interacción..."));
    });

    function volverAlMenu() {
      video.pause();
      video.currentTime = 0;
      grupoVideo.setAttribute('visible', 'false');
      telon.emit('cineEnd'); 
      textoBoton.setAttribute('value', 'VUELVE A VER\nNUESTRA HISTORIA');
      contenedorBtn.setAttribute('visible', 'true');
      // Resetear barra visualmente
      barraProgreso.setAttribute('width', 0.01);
      barraProgreso.setAttribute('position', '-2.5 -1.6 0.02');
    }

    document.querySelector('#btnReset').addEventListener('click', () => {
      video.currentTime = 0;
      video.play();
      txtPausa.setAttribute('value', 'PAUSA');
      actualizarInterfaz();
    });

    document.querySelector('#btnSalir').addEventListener('click', volverAlMenu);
    video.addEventListener('ended', volverAlMenu);

    document.querySelector('#btnPausa').addEventListener('click', () => {
      if (video.paused) { 
        video.play(); 
        txtPausa.setAttribute('value', 'PAUSA');
        actualizarInterfaz(); 
      } else { 
        video.pause(); 
        txtPausa.setAttribute('value', 'PLAY'); 
      }
    });

    document.querySelector('#btnNormal').addEventListener('click', () => video.playbackRate = 1);
    document.querySelector('#btnRapido').addEventListener('click', () => video.playbackRate = 4);
  </script>
</body>
</html>













